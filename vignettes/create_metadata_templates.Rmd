---
title: "Create metadata templates"
output: html_document
---

```{r setup, include=FALSE}

# Initialize .Rmd

knitr::opts_chunk$set(echo = TRUE)
library(kableExtra)
library(EMLassemblyline)

# Remove example package directory

unlink(
  paste0(
    tempdir(),
    '/pkg_301'
  ), 
  recursive = TRUE
)

# Create the data package directory from organize_data_package.Rmd

template_directories(
  path = tempdir(),
  dir.name = 'pkg_301'
)

# Set working directory

knitr::opts_knit$set(root.dir = tempdir())

```

## Templating functions

Metadata templates store content that is converted into EML. Each template is created by a function that reads a data object, extracts as much information as possible, then writes this information to file for the user to add information to if necessary. Each templating function focuses on a specific metadata feature thereby allowing the user to build metadata in a modular fashion. Currently available templating functions include:

*  __`template_core_metadata()`__ Create core metadata templates required by all data packages (abstract, methods, keywords, personnel, license). The _additional information_ template (optional) is included.
*  __`template_table_attributes()`__ Create attribute metadata for data tables, including column definitions, classes, and missing value codes. The _custom units_ template is created incase non-standard units need definition.
*  __`template_categorical_variables()`__ Create categorical variable metadata for data tables, if needed.
*  __`template_geographic_coverage()`__ Create geographic coverage describing location names, points, and areas.
*  __`template_taxonomic_coverage()`__ Create taxonomic coverage metadata facilitating resolution to authority systems and returning hierarchical rank names.

Below is a demonstration of each function and a look at outputs.

## template_core_metadata()

Use `template_core_metadata()` to create metadata templates required by every data package.

```{r call template_core_metadata, message = TRUE}

# Continuing with the data package directory ("pkg_301") set up in
# the article "Organize data package" ...

# The templates directory is empty
dir('./pkg_301/metadata_templates')

# Template core metadata
template_core_metadata(
  path = './pkg_301/metadata_templates',
  license = 'CC0'
)

# Core templates are now present
dir('./pkg_301/metadata_templates')

```

## template_table_attributes()

Use `template_table_attributes()` to create templates required by data tables.

```{r call template_table_attributes, message = TRUE}

# Add a couple tables to "pkg_301"

file.copy(
  from = system.file('/examples/data/nitrogen.csv', package = 'EMLassemblyline'),
  to = './pkg_301/data_objects'
)

file.copy(
  from = system.file('/examples/data/decomp.csv', package = 'EMLassemblyline'),
  to = './pkg_301/data_objects'
)
 
# Tables are now present
dir('./pkg_301/data_objects')

# Template table attributes for each table
template_table_attributes(
  path = './pkg_301/metadata_templates',
  data.path = './pkg_301/data_objects',
  data.table = c('decomp.csv', 'nitrogen.csv')
)

# Table attributes templates are now present
dir('./pkg_301/metadata_templates')

# View templates
# NOTE: attributeName and class are autogenerated, and unit and 
# dateTimeFormatString note where specific content is needed.

```

```{r view attributes, echo=FALSE}

# Change taxa class from categorical to character

attributes_decomp <- read.table(
  file = './pkg_301/metadata_templates/attributes_decomp.txt',
  header = TRUE,
  sep = '\t',
  quote = "\"",
  as.is = TRUE,
  comment.char = "",
  fill = T,
  colClasses = rep("character", 7)
)

attributes_decomp$class[attributes_decomp$attributeName == 'taxa'] <- 'character'

write.table(
  x = attributes_decomp,
  file = './pkg_301/metadata_templates/attributes_decomp.txt', 
  sep = '\t',
  row.names = FALSE,
  quote = FALSE
)

# Read attribute templates

attributes_decomp <- read.table(
  file = './pkg_301/metadata_templates/attributes_decomp.txt',
  header = TRUE,
  sep = '\t',
  quote = "\"",
  as.is = TRUE,
  comment.char = "",
  fill = T,
  colClasses = rep("character", 7)
)

attributes_nitrogen <- read.table(
  file = './pkg_301/metadata_templates/attributes_nitrogen.txt',
  header = TRUE,
  sep = '\t',
  quote = "\"",
  as.is = TRUE,
  comment.char = "",
  fill = T,
  colClasses = rep("character", 7)
)

# Display attribute templates

knitr::kable(
  attributes_decomp, caption = 'attributes_decomp.txt') %>%
  kableExtra::kable_styling('bordered', font_size = 12) %>%
  kableExtra::scroll_box(width = '100%', height = '300px')


knitr::kable(
  attributes_nitrogen, caption = 'attributes_nitrogen.txt') %>%
  kableExtra::kable_styling('bordered', font_size = 12) %>%
  kableExtra::scroll_box(width = '100%', height = '300px')

```

## template_categorical_variables()

Use `template_categorical_variables()` if any data table contains categorical variables.

```{r call template_categorical_variables, message = TRUE}

# Replace partially complete table attributes templates with fully completed 
# ones as required by template_categorical_variables()

file.copy(
  from = system.file('/examples/templates/attributes_nitrogen.txt', package = 'EMLassemblyline'),
  to = './pkg_301/metadata_templates',
  overwrite = TRUE
)

file.copy(
  from = system.file('/examples/templates/attributes_decomp.txt', package = 'EMLassemblyline'),
  to = './pkg_301/metadata_templates',
  overwrite = TRUE
)

# Template categorical variables
template_categorical_variables(
  path = './pkg_301/metadata_templates',
  data.path = './pkg_301/data_objects'
)

# Categorical variable templates are now present
dir('./pkg_301/metadata_templates')

# View templates
# NOTE: attributeName and code is auto generated.

```

```{r view catvars, echo=FALSE}

# Read catvar templates

catvars_decomp <- read.table(
  file = './pkg_301/metadata_templates/catvars_decomp.txt',
  header = TRUE,
  sep = '\t',
  quote = "\"",
  as.is = TRUE,
  comment.char = "",
  fill = T,
  colClasses = rep("character", 3)
)

catvars_nitrogen <- read.table(
  file = './pkg_301/metadata_templates/catvars_nitrogen.txt',
  header = TRUE,
  sep = '\t',
  quote = "\"",
  as.is = TRUE,
  comment.char = "",
  fill = T,
  colClasses = rep("character", 3)
)

# Display catvar templates

knitr::kable(
  catvars_decomp, caption = 'catvars_decomp.txt') %>%
  kableExtra::kable_styling('bordered', font_size = 12) %>%
  kableExtra::scroll_box(width = '35%', height = '300px')


knitr::kable(
  catvars_nitrogen, caption = 'catvars_nitrogen.txt') %>%
  kableExtra::kable_styling('bordered', font_size = 12) %>%
  kableExtra::scroll_box(width = '35%', height = '300px')

```

## template_geographic_coverage()

Use `template_geographic_coverage()` to document the locations of sampling points or areas. _NOTE:_ Use the `empty = TRUE` argument to create a blank version of this template for manual editing.

```{r call template_geographic_coverage, message = TRUE}

# Template geographic coverage
template_geographic_coverage(
  path = './pkg_301/metadata_templates',
  data.path = './pkg_301/data_objects',
  data.table = 'nitrogen.csv',
  site.col = 'site_name',
  lat.col = 'site_lat',
  lon.col = 'site_lon'
)

# The geographic coverage template has been added
dir('./pkg_301/metadata_templates')

# View template

```

```{r view geographic_coverage.txt, echo=FALSE}

# Read geocoverage template

geocoverage <- read.table(
  file = './pkg_301/metadata_templates/geographic_coverage.txt',
  header = TRUE,
  sep = '\t',
  quote = "\"",
  as.is = TRUE,
  comment.char = "",
  fill = T,
  colClasses = rep("character", 5)
)

# Display geocoverage template

knitr::kable(
  geocoverage, caption = 'geographic_coverage.txt') %>%
  kableExtra::kable_styling('bordered', font_size = 12) %>%
  kableExtra::scroll_box(width = '100%', height = '400px')

```

## template_taxonomic_coverage()

Use `template_taxonomic_coverage()` to automatically resolve taxa to authority systems and create hierarchical rank specific metadata.

```{r call template_taxonomic_coverage, message = TRUE}

# Template taxonomic coverage
template_taxonomic_coverage(
  path = './pkg_301/metadata_templates',
  data.path = './pkg_301/data_objects',
  taxa.table = 'decomp.csv',
  taxa.col = 'taxa',
  taxa.authority = c(3,11),
  taxa.name.type = 'both'
)

# The taxonomic coverage template is present
dir('./pkg_301/metadata_templates')

# View template
# NOTE: Unresolved taxa lack authority information

```

```{r view taxonomic_coverage.txt, echo=FALSE}

# Read taxonomic coverage template

taxacoverage <- read.table(
  file = './pkg_301/metadata_templates/taxonomic_coverage.txt',
  header = TRUE,
  sep = '\t',
  quote = "\"",
  as.is = TRUE,
  comment.char = "",
  fill = T,
  colClasses = rep("character", 5)
)

# Display taxonomic coverage template

knitr::kable(
  taxacoverage, caption = 'taxonomic_coverage.txt') %>%
  kableExtra::kable_styling('bordered', font_size = 12) %>%
  kableExtra::scroll_box(width = '70%', height = '400px')

```
